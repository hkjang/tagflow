# 웹훅 설정

TagFlow의 웹훅 시스템을 설정하고 관리하는 방법을 안내합니다.

```
⚠️ 관리자 전용 기능
이 기능은 관리자(Admin) 역할만 사용할 수 있습니다.
```

## 웹훅이란?

웹훅은 RFID 태그 이벤트가 발생할 때 자동으로 외부 시스템에 데이터를 전송하는 기능입니다.

### 사용 사례

- **ERP 시스템 연동**: 태그 스캔 시 재고 관리 시스템 업데이트
- **알림 시스템**: Slack, Teams 등으로 즉시 알림 전송
- **데이터 동기화**: 외부 데이터베이스 또는 클라우드 서비스와 동기화
- **로깅 시스템**: 중앙 로깅 서버로 이벤트 전송

## 웹훅 관리 페이지 접근

1. 관리자 계정으로 로그인
2. 사이드바에서 **관리 > 웹훅** 클릭
3. 현재 등록된 모든 웹훅 목록이 표시됩니다

## 웹훅 목록 조회

### 웹훅 정보

웹훅 목록에는 다음 정보가 표시됩니다:

| 컬럼       | 설명                   |
| ---------- | ---------------------- |
| **이름**   | 웹훅 식별 이름         |
| **URL**    | 대상 엔드포인트 주소   |
| **메서드** | HTTP 메서드 (POST/PUT) |
| **활성**   | 활성화 상태 (ON/OFF)   |
| **성공률** | 웹훅 전송 성공률       |
| **작업**   | 편집/테스트/삭제 버튼  |

### 상태 표시

- **🟢 활성**: 웹훅이 활성화되어 이벤트 발생 시 자동 전송
- **🔴 비활성**: 웹훅이 비활성화되어 전송하지 않음
- **⚠️ 오류**: 최근 전송 실패가 있음

## 새 웹훅 생성

### 단계별 가이드

#### 1. 웹훅 생성 버튼 클릭

웹훅 관리 페이지 상단의 **"+ 새 웹훅"** 버튼을 클릭합니다.

#### 2. 기본 정보 입력

**웹훅 이름**:

```
예시: "ERP 재고 업데이트", "Slack 알림", "데이터 백업"
```

- 식별하기 쉬운 이름 사용
- 한글, 영문 모두 가능
- 2~100자 사이

**대상 URL**:

```
예시: https://api.example.com/webhooks/rfid
```

- 반드시 HTTPS 사용 권장
- 유효한 URL 형식
- 테스트된 엔드포인트 사용

**HTTP 메서드**:

- **POST**: 새 데이터 생성 (기본값, 권장)
- **PUT**: 데이터 업데이트

**활성화**:

- ✅ 체크: 즉시 활성화
- ⬜ 체크 해제: 비활성 상태로 저장 (나중에 활성화 가능)

#### 3. 인증 설정 (선택사항)

외부 시스템이 인증을 요구하는 경우:

**인증 헤더**:

```
예시: Authorization
```

**인증 값**:

```
예시: Bearer your-api-token-here
```

일반적인 인증 방식:

- **Bearer Token**: `Bearer {token}`
- **API Key**: `{api-key}`
- **Basic Auth**: `Basic {base64}`

#### 4. 필드 매핑 구성

필드 매핑은 TagFlow의 이벤트 데이터를 외부 시스템이 이해할 수 있는 형식으로 변환합니다.

**TagFlow 기본 이벤트 필드**:

- `id`: 이벤트 고유 ID
- `tagId`: RFID 태그 UID
- `timestamp`: 스캔 시간 (ISO 8601 형식)
- `deviceId`: 리더 장치 ID
- `location`: 위치 정보

**매핑 추가 방법**:

1. **"+ 필드 추가"** 버튼 클릭
2. **소스 필드** 선택: TagFlow 이벤트 필드
3. **대상 필드** 입력: 외부 시스템에서 사용하는 필드명
4. 필요한 모든 필드에 대해 반복

**매핑 예시**:

```
TagFlow → 외부 시스템

tagId → rfid_uid
timestamp → scan_time
deviceId → reader_id
location → zone_name
```

#### 5. 재시도 설정

웹훅 전송 실패 시 재시도 정책:

**최대 재시도 횟수**:

```
기본값: 3회
권장값: 3~5회
```

**재시도 간격**:

```
기본값: 60초
권장값: 30~300초
```

#### 6. 저장

모든 설정을 완료한 후 **"생성"** 버튼을 클릭합니다.

### 생성 예시

#### 예시 1: Slack 알림 웹훅

```
이름: Slack RFID 알림
URL: https://hooks.slack.com/services/YOUR/WEBHOOK/URL
메서드: POST
활성화: ✅

필드 매핑:
- tagId → text
- timestamp → timestamp

재시도: 3회, 60초 간격
```

전송되는 데이터:

```json
{
  "text": "TAG_12345678",
  "timestamp": "2025-12-03T06:30:00Z"
}
```

#### 예시 2: ERP 시스템 연동

```
이름: ERP 재고 업데이트
URL: https://erp.company.com/api/inventory/scan
메서드: POST
활성화: ✅

인증:
- 헤더: Authorization
- 값: Bearer abcd1234...

필드 매핑:
- tagId → item_code
- timestamp → scanned_at
- location → warehouse_zone
- deviceId → scanner_id

재시도: 5회, 120초 간격
```

전송되는 데이터:

```json
{
  "item_code": "TAG_12345678",
  "scanned_at": "2025-12-03T06:30:00Z",
  "warehouse_zone": "A-1",
  "scanner_id": "READER_01"
}
```

## 웹훅 편집

### 기존 웹훅 수정

1. 웹훅 목록에서 **편집** 버튼 클릭
2. 수정할 정보 변경
3. **"저장"** 버튼 클릭

```
⚠️ 주의
웹훅 URL을 변경하는 경우, 반드시 테스트를 다시 수행하세요.
```

### 일시 비활성화

웹훅을 삭제하지 않고 일시적으로 중지하려면:

1. 웹훅 편집 페이지에서 **활성화** 체크박스 해제
2. **"저장"** 클릭

비활성화된 웹훅은 이벤트가 발생해도 전송되지 않습니다.

## 웹훅 테스트

```
💡 중요
웹훅을 활성화하기 전에 반드시 테스트하세요!
```

### 테스트 실행 방법

#### 1. 테스트 버튼 클릭

웹훅 목록 또는 편집 페이지에서 **"테스트"** 버튼을 클릭합니다.

#### 2. 테스트 데이터 전송

시스템이 샘플 데이터로 웹훅을 호출합니다:

```json
{
  "tagId": "TEST_12345678",
  "timestamp": "2025-12-03T06:30:00Z",
  "deviceId": "TEST_DEVICE",
  "location": "TEST_LOCATION"
}
```

#### 3. 결과 확인

테스트 결과가 표시됩니다:

**성공 (HTTP 200-299)**:

```
✅ 테스트 성공
응답 코드: 200
응답 시간: 234ms
```

**실패**:

```
❌ 테스트 실패
응답 코드: 404
오류: Not Found
```

### 테스트 모범 사례

1. **개발 환경에서 먼저 테스트**

   - 프로덕션 URL로 바로 테스트하지 마세요
   - 개발/테스트 엔드포인트로 먼저 검증

2. **로그 확인**

   - 외부 시스템의 로그도 함께 확인
   - 데이터가 올바르게 전달되었는지 검증

3. **반복 테스트**
   - 여러 번 테스트하여 일관성 확인
   - 네트워크 장애 시나리오 고려

## 웹훅 로그 조회

### 로그 페이지 접근

웹훅 관리 페이지에서 특정 웹훅의 **"로그"** 버튼을 클릭합니다.

### 로그 정보

각 웹훅 호출 기록에는 다음 정보가 포함됩니다:

| 필드            | 설명              |
| --------------- | ----------------- |
| **시간**        | 웹훅 전송 시간    |
| **상태**        | 성공/실패         |
| **응답 코드**   | HTTP 상태 코드    |
| **응답 시간**   | 응답 속도 (ms)    |
| **재시도 횟수** | 재시도 시도 횟수  |
| **오류 메시지** | 실패 시 오류 내용 |

### 필터링

- **상태별**: 성공/실패 필터
- **기간별**: 특정 날짜 범위
- **검색**: 태그 ID로 검색

## 문제 해결

### 웹훅이 전송되지 않아요

**증상**: 이벤트가 발생해도 웹훅이 호출되지 않습니다.

**체크리스트**:

1. **웹훅 활성화 상태 확인**

   - 웹훅이 활성화되어 있는지 확인
   - 편집 페이지에서 활성화 체크박스 확인

2. **URL 유효성 확인**

   - URL이 올바른지 확인
   - HTTPS 프로토콜 사용 권장
   - 대상 서버가 실행 중인지 확인

3. **네트워크 연결 확인**

   - TagFlow 서버에서 대상 URL에 접근 가능한지 확인
   - 방화벽 설정 검토

4. **웹훅 로그 확인**
   - 로그에서 구체적인 오류 메시지 확인

### 웹훅이 계속 실패해요

**증상**: 웹훅 전송이 반복적으로 실패합니다.

**가능한 원인 및 해결책**:

1. **401/403 오류 - 인증 실패**

   ```
   해결: 인증 헤더와 토큰 값 재확인
   ```

2. **404 오류 - URL 오류**

   ```
   해결: 대상 URL 경로 확인
   ```

3. **500 오류 - 서버 오류**

   ```
   해결:
   - 필드 매핑 확인
   - 외부 시스템 로그 확인
   - 데이터 형식 검증
   ```

4. **타임아웃**
   ```
   해결:
   - 대상 서버 성능 확인
   - 네트워크 지연 점검
   ```

### 일부 필드가 전송되지 않아요

**증상**: 매핑한 필드 중 일부만 전달됩니다.

**해결책**:

1. **필드 매핑 재확인**

   - 소스 필드명이 정확한지 확인
   - 대소문자 구분 주의

2. **웹훅 로그에서 전송 데이터 확인**

   - 실제 전송된 JSON 확인

3. **외부 시스템 검증**
   - 외부 시스템이 해당 필드를 지원하는지 확인

### 재시도가 너무 많아요

**증상**: 웹훅이 실패 후 과도하게 재시도합니다.

**해결책**:

1. **재시도 횟수 조정**

   - 웹훅 편집에서 최대 재시도 횟수 감소
   - 예: 3회 → 1회

2. **재시도 간격 조정**

   - 간격을 늘려 시스템 부하 감소
   - 예: 60초 → 300초

3. **근본 원인 해결**
   - 재시도 전에 실패 원인을 먼저 해결

## 웹훅 모범 사례

### 보안

1. **HTTPS 필수**

   ```
   ✅ https://api.example.com/webhook
   ❌ http://api.example.com/webhook
   ```

2. **인증 사용**

   - API 토큰 또는 인증 키 사용
   - 정기적으로 토큰 갱신

3. **민감 정보 제외**
   - 개인정보는 필드 매핑에서 제외
   - 필요한 데이터만 전송

### 성능

1. **대상 엔드포인트 최적화**

   - 응답 시간 200ms 이내 권장
   - 비동기 처리 구현

2. **적절한 재시도 설정**

   - 과도한 재시도는 시스템 부하 증가
   - 3~5회 권장

3. **배치 처리 고려**
   - 대량 이벤트 발생 시 배치 웹훅 고려
   - 현재 버전: 개별 전송만 지원

### 모니터링

1. **웹훅 로그 정기 확인**

   - 주 1회 이상 로그 검토
   - 성공률 모니터링

2. **알림 설정**

   - 실패율이 높으면 알림
   - 관리자에게 이메일 또는 슬랙 알림

3. **외부 시스템 협업**
   - 외부 시스템 담당자와 정기적으로 소통
   - 변경사항 사전 공유

## 웹훅 삭제

### 삭제 절차

1. 웹훅 목록에서 **삭제** 버튼 클릭
2. 확인 대화상자에서 **"삭제"** 확인
3. 삭제된 웹훅은 복구할 수 없습니다

```
⚠️ 주의
- 삭제 전에 웹훅을 비활성화로 전환하여 테스트하는 것을 권장합니다
- 삭제된 웹훅의 로그도 함께 삭제됩니다 (90일 보존 정책에 따라)
```

## API를 통한 웹훅 관리

개발자는 REST API로도 웹훅을 관리할 수 있습니다.

### 웹훅 목록 조회

```bash
GET /webhooks
Authorization: Bearer {access_token}
```

### 웹훅 생성

```bash
POST /webhooks
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "name": "My Webhook",
  "url": "https://api.example.com/webhook",
  "method": "POST",
  "isActive": true,
  "authHeader": "Authorization",
  "authValue": "Bearer token123",
  "mappings": [
    {
      "sourceField": "tagId",
      "targetField": "rfid_uid"
    }
  ],
  "maxRetries": 3,
  "retryInterval": 60
}
```

### 웹훅 테스트

```bash
POST /webhooks/:id/test
Authorization: Bearer {access_token}
```

자세한 API 사용법은 [API 레퍼런스](../../developer-guides/api-reference.md)를 참조하세요.

## 고급 시나리오

### 여러 시스템에 동시 전송

하나의 이벤트를 여러 외부 시스템에 전송하려면:

1. 각 시스템별로 별도의 웹훅 생성
2. 모두 활성화
3. 이벤트 발생 시 모든 웹훅이 동시에 호출됨

### 조건부 웹훅

현재 버전에서는 조건부 웹훅을 지원하지 않습니다. 모든 이벤트가 활성 웹훅으로 전송됩니다.

향후 버전에서 필터링 기능이 추가될 예정입니다.

## 관련 문서

- [웹훅 시스템 아키텍처](../../feature-guides/webhook-system.md)
- [RFID 이벤트 추적](../../feature-guides/rfid-event-tracking.md)
- [API 레퍼런스](../../developer-guides/api-reference.md)
- [문제 해결](../../deployment/troubleshooting.md)
